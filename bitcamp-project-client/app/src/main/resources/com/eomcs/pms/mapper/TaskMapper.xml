<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="TaskMapper">

<resultMap id="taskMap" type="com.eomcs.pms.domain.Task">
<id column="no" property="no"/>
<result column="content" property="content"/>
<result column="deadline" property="deadline"/>
<result column="owner" property="owner"/>
<result column="status" property="status"/>
<result column="projectNo" property="projectNo"/>
<result column="projectTitle" property="projectTitle"/>

<association property="owner" javaType="com.eomcs.pms.domain.Member"/>
<association property="project" javaType="com.eomcs.pms.domain.Project">
<result column="owner_no" property="no"/>
<result column="owner_name" property="name"/>
<result column="project_no" property="no"/>
<result column="project_name" property="title"/>

</association>


</resultMap>
  
  <insert id="insert" parameterType="com.eomcs.pms.domain.Task">
  insert into pms_task(content,deadline,owner,status,project_no) 
  values(#{content},#{deadline},#{owner},#{status},#{project_no})
  </insert>
  
  <!-- findAll()에서 사용할 SQL -->
  <select id="findAll" resultMap="taskMap">
        select 
           t.no,
            t.content,
            t.deadline,
            t.status,
            m.no as owner_no,
            m.name as owner_name,
            p.no as project_no,
            p.title as project_title
          from pms_task t
            inner join pms_member m on t.owner=m.no
            inner join pms_project p on t.project_no=p.no
         where t.project_no=? or 0=?
         order by p.no desc, t.content asc
  </select>
  
    <select id="findByKeyword" resultMap="taskMap" parameterType="string">
   select
     b.no,
     b.title,
     b.cdt,
     b.vw_cnt,
     b.like_cnt,
     m.no as writer_no,
     m.name as writer_name
    from pms_board b
     inner join pms_member m on m.no=b.writer
    where
     b.title like concat('%',#{value},'%')
     b.content like concat('%',#{value},'%')
     m.name like concat('%',#{value},'%')
     order by b.no desc
  </select>
  
  <select id="findByNo" resultMap="taskMap" parameterType="int">
     select 
         t.no,
         t.content,
         t.deadline,
         t.status,
         m.no as owner_no,
         m.name as owner_name,
         p.no as project_no,
         p.title as project_title
     from pms_task t 
         inner join pms_member m on t.owner=m.no
         inner join pms_project p on t.project_no=p.no
      where t.no=#{no}
    </select>
    
    <update id="update" parameterType="com.eomcs.pms.domain.Board">
  update pms_task set 
  content = #{content},
  deadline = #{deadline},
  owner = #{owner},
  status = #{status},
  project_no = #{project_no} 
  where no = #{no}
    </update>
    
    <update id="updateViewCount" parameterType="int">
   update pms_board set 
   vw_cnt = vw_cnt + 1 
    where no = #{value}
    </update>
    
    <delete id="delete" parameterType="int">
    delete from pms_task 
    where no = #{no}
    </delete>
  
</mapper>







